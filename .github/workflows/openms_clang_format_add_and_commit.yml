# Action to allow clang format linting at the files changed in the PR

on:
  issue_comment:
    types: [created]

jobs:
  clang_format:
    name: Automatic clang format linting
    runs-on: ubuntu-latest
    if: github.event.issue.pull_request != '' && contains(github.event.comment.body, '/reformat')
    steps:
      - uses: actions/checkout@v2
        with:
          path: OpenMS

# Get files changed in the PR and filter for valid extensions
      - name: Acquire files to lint
        id: acquire_files_to_lint
        uses: jitterbit/get-changed-files@v1
        with:
          filter: |
            '*.h'
            '*.cpp'

# Correct path information to OpenMS
      - name: Correct files to lint
        id: correct_files_to_lint
        run: |
            for changed_file in ${{ steps.acquire_files_to_lint.outputs.added_modified }}; do
              current_filename=$(basename -- "$changed_file")
              current_extension="${current_filename##*.}"
              append_path=" ./OpenMS/${changed_file}"
              files+=${append_path}
            done
            echo ::set-output name=filestolint::$(echo $files)

# Perform linting
      - name: Use clang format linting
        uses: DoozyX/clang-format-lint-action@v0.12
        with:
          source: ${{ steps.correct_files_to_lint.outputs.filestolint }}
          clangFormatVersion: 12
          inplace: True
      - uses: EndBug/add-and-commit@v4
        with:
          message: 'Committing clang-format changes'
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
